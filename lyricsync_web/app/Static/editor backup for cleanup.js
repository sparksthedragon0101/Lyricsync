
let wavesurfer, regions, timeline;
let project = null;
let currentId = null;
let dirty = false;
function $(sel){ return document.querySelector(sel); }
function el(tag, props={}, ...children){ const e=document.createElement(tag); Object.assign(e, props); for(const c of children) e.append(c); return e; }
async function fetchJSON(url, opts={}){ const r=await fetch(url, Object.assign({headers:{"Content-Type":"application/json"}}, opts)); if(!r.ok) throw new Error(await r.text()); return await r.json(); }
function fmt(sec){ return (Math.max(0, sec)||0).toFixed(2) + "s"; }
function setDirty(v){ dirty=v; $("#dirty").classList.toggle("hidden", !dirty); }
function findSeg(id){ return project.segments.find(s => s.id === id); }
function refreshList(){ const ul=$("#lines"); ul.innerHTML=""; project.segments.forEach(seg=>{ const li=el("li",{textContent:`${seg.id}: ${seg.text}`}); li.dataset.id=seg.id; if(seg.id===currentId) li.classList.add("active"); li.onclick=()=>selectSeg(seg.id,true); ul.append(li); }); }
function selectSeg(id, scroll=false){ currentId=id; document.querySelectorAll("#lines li").forEach(li=>li.classList.toggle("active", li.dataset.id===id)); const seg=findSeg(id); if(!seg) return; $("#selNone").classList.add("hidden"); $("#selPanel").classList.remove("hidden"); $("#selText").value=seg.text; $("#selStart").value=seg.start.toFixed(3); $("#selEnd").value=seg.end.toFixed(3); $("#selDur").value=(seg.end-seg.start).toFixed(3)+"s"; const r=regions.getRegions().find(r=>r.id===id); if(r){ regions.getRegions().forEach(x=>x.element.classList.remove("selected")); r.element.classList.add("selected"); if(scroll) wavesurfer.setTime(seg.start+0.01); } }
function rebuildRegions(){ regions.clearRegions(); project.segments.forEach(seg=>{ regions.addRegion({ id:seg.id, start:seg.start, end:seg.end, content:seg.text, drag:true, resize:true, color:"rgba(122,162,247,0.12)" }); }); }
async function loadProject(){ project=await fetchJSON(`/api/projects/${SLUG}/timing`); wavesurfer=WaveSurfer.create({container:'#wave', waveColor:'#7aa2f7', progressColor:'#9ece6a', height:200, url:`/api/projects/${SLUG}/audio`, minPxPerSec:60}); timeline=wavesurfer.registerPlugin(WaveSurfer.Timeline.create({container:'#timeline'})); regions=wavesurfer.registerPlugin(WaveSurfer.Regions.create()); wavesurfer.on('timeupdate',(t)=>{$("#time").textContent=fmt(t);}); regions.on('region-updated',(reg)=>{ const seg=findSeg(reg.id); if(seg){ const oldStart=seg.start; seg.start=reg.start; seg.end=reg.end; if($("#ripple").checked){ const delta=reg.start-oldStart; let hit=false; for(const s of project.segments){ if(s.id===seg.id){hit=true;continue;} if(hit){ s.start+=delta; s.end+=delta; } } rebuildRegions(); } setDirty(true); selectSeg(seg.id); refreshList(); } }); regions.on('region-clicked',(r,e)=>{ e.stopPropagation(); selectSeg(r.id,true); }); wavesurfer.on('ready',()=>{ rebuildRegions(); refreshList(); if(project.segments.length) selectSeg(project.segments[0].id); }); }
async function saveProject(){ await fetchJSON(`/api/projects/${SLUG}/timing`, {method:"POST", body: JSON.stringify(project)}); setDirty(false); $("#status").textContent="Saved."; setTimeout(()=>$("#status").textContent="", 1200); }
async function exportSrt(){ await saveProject(); const r=await fetchJSON(`/api/projects/${SLUG}/export_srt`, {method:"POST"}); $("#status").textContent="Exported SRT â†’ "+r.path; }
async function importSrt(){ await fetchJSON(`/api/projects/${SLUG}/import_srt`, {method:"POST"}); project=await fetchJSON(`/api/projects/${SLUG}/timing`); rebuildRegions(); refreshList(); if(project.segments.length) selectSeg(project.segments[0].id); $("#status").textContent="Imported SRT."; }
function nudgeSelected(delta){ if(!currentId) return; const s=findSeg(currentId); if(!s) return; s.start=Math.max(0,s.start+delta); s.end=Math.max(s.start+0.01,s.end+delta); rebuildRegions(); selectSeg(currentId); setDirty(true); }
function trimToCursor(which){ if(!currentId) return; const s=findSeg(currentId); const t=wavesurfer.getCurrentTime(); if(which==='start') s.start=Math.min(t,s.end-0.01); else s.end=Math.max(t,s.start+0.01); rebuildRegions(); selectSeg(currentId); setDirty(true); }
function splitAtCursor(){ if(!currentId) return; const s=findSeg(currentId); const t=wavesurfer.getCurrentTime(); if(t<=s.start+0.05||t>=s.end-0.05) return; const idx=project.segments.findIndex(x=>x.id===s.id); const left={id:s.id,text:s.text,start:s.start,end:t}; const right={id:"L"+(project.segments.length+1),text:s.text,start:t,end:s.end}; project.segments.splice(idx,1,left,right); rebuildRegions(); refreshList(); selectSeg(right.id); setDirty(true); }
function mergeWithNext(){ if(!currentId) return; const idx=project.segments.findIndex(x=>x.id===currentId); if(idx<0||idx>=project.segments.length-1) return; const a=project.segments[idx], b=project.segments[idx+1]; a.end=b.end; a.text=(a.text+" "+b.text).trim(); project.segments.splice(idx+1,1); rebuildRegions(); refreshList(); selectSeg(a.id); setDirty(true); }
document.addEventListener("keydown",(e)=>{ if(e.code==="Space"){e.preventDefault(); wavesurfer.playPause();} if(e.code==="Home"){wavesurfer.setTime(0);} if(e.key==="j"){ const idx=project.segments.findIndex(s=>s.id===currentId); if(idx>0) selectSeg(project.segments[idx-1].id,true);} if(e.key==="k"){ const idx=project.segments.findIndex(s=>s.id===currentId); if(idx>=0&&idx<project.segments.length-1) selectSeg(project.segments[idx+1].id,true);} if(e.key==="ArrowLeft") nudgeSelected(e.ctrlKey?-0.001:(e.shiftKey?-0.05:-0.01)); if(e.key==="ArrowRight") nudgeSelected(e.ctrlKey?0.001:(e.shiftKey?0.05:0.01)); if(e.key==="[") trimToCursor('start'); if(e.key==="]") trimToCursor('end'); if(e.key==="s") splitAtCursor(); if(e.key==="m") mergeWithNext(); if(e.key==="+") wavesurfer.zoom(wavesurfer.params.minPxPerSec+20); if(e.key==="-") wavesurfer.zoom(Math.max(20,wavesurfer.params.minPxPerSec-20)); });
$("#play").onclick=()=>wavesurfer.playPause(); $("#stop").onclick=()=>wavesurfer.stop(); $("#prev").onclick=()=>{ const idx=project.segments.findIndex(s=>s.id===currentId); if(idx>0) selectSeg(project.segments[idx-1].id,true); }; $("#next").onclick=()=>{ const idx=project.segments.findIndex(s=>s.id===currentId); if(idx>=0&&idx<project.segments.length-1) selectSeg(project.segments[idx+1].id,true); }; $("#zoomIn").onclick=()=>wavesurfer.zoom(wavesurfer.params.minPxPerSec+20); $("#zoomOut").onclick=()=>wavesurfer.zoom(Math.max(20,wavesurfer.params.minPxPerSec-20)); $("#selText").addEventListener("input",(e)=>{ if(!currentId) return; const s=findSeg(currentId); s.text=e.target.value; setDirty(true); refreshList(); }); $("#selStart").addEventListener("change",(e)=>{ const v=parseFloat(e.target.value)||0; const s=findSeg(currentId); s.start=Math.min(v,s.end-0.01); rebuildRegions(); selectSeg(currentId); setDirty(true); }); $("#selEnd").addEventListener("change",(e)=>{ const v=parseFloat(e.target.value)||0; const s=findSeg(currentId); s.end=Math.max(v,s.start+0.01); rebuildRegions(); selectSeg(currentId); setDirty(true); }); $("#save").onclick=saveProject; $("#exportSrt").onclick=exportSrt; $("#importSrt").onclick=importSrt; loadProject().catch(err=>{ console.error(err); $("#status").textContent="Failed to load project: "+err.message; });
